# Changelog

Все значительные изменения в Starvell Cardinal будут документироваться в этом файле.

## [0.0.18] - 2026-01-11

### Исправлено

- **Обработка старых сообщений при перезапуске**: Бот больше не отправляет уведомления о сообщениях и заказах, полученных во время простоя
  - При первом запуске после рестарта бот пропускает старые сообщения
  - При первом запуске после рестарта бот пропускает старые заказы
  - Добавлены флаги `_first_check_messages` и `_first_check_orders` для отслеживания первой проверки
- **Отображение nickname вместо ID**: Исправлено отображение имени пользователя в уведомлениях и плагинах
  - Плагины теперь получают nickname пользователя вместо ID в поле `author`
  - Если nickname недоступен, используется ID как fallback
  - Улучшена логика извлечения nickname из данных чата

### Добавлено

- **Получение nickname по API**: Добавлен механизм получения nickname пользователя по его ID через Starvell API
  - Новый метод `get_user_profile(user_id)` в `StarAPI` для запроса профиля пользователя
  - Метод `_get_nickname_by_id()` в `NotificationManager` с кэшированием результатов
  - Автоматическое получение nickname если он отсутствует в данных чата
  - Кэш nickname для уменьшения количества API запросов

## [0.0.17] - 2026-01-11

### Исправлено

- **Критическая проблема с плагинами**: Плагины теперь получают события независимо от настроек уведомлений
  - Плагины всегда получают события новых сообщений
  - Плагины всегда получают события новых заказов
  - Исправлена ситуация, когда при выключенных уведомлениях плагины не работали
  - Уведомления по-прежнему отправляются только если включены в настройках

## [0.0.16] - 2026-01-08

### Добавлено

- **Настройка автоответов (кастомные команды)**: Новое меню для создания пользовательских команд с префиксами
  - Добавление/редактирование/удаление команд через бота
  - Настраиваемый префикс команд (!, /, . и т.д.)
  - Пагинация списка команд (по 5 на страницу)
  - Глобальный переключатель включения/выключения
  - Автоматическая обработка команд в чатах покупателей
  - Хранение команд в JSON файле `storage/custom_commands.json`
- **Кнопка "Настройка автоответов"**: Добавлена в главное меню между "Настройки уведомлений" и "Автовыдача"

### Улучшено

- **Переключатели автоответов**: Исправлен баг перехода в "Глобальные переключатели"
  - Кнопки вкл/выкл ответов на заказ теперь остаются в своём меню
  - Кнопки вкл/выкл ответов на отзыв теперь остаются в своём меню
  - Улучшена навигация и UX

### Удалено

- **install-sc.sh**: Удалён ненужный скрипт установки

### Технические изменения

- Добавлен новый модуль `bot/handlers/custom_commands_handlers.py`
- Добавлена функция `get_custom_commands_menu()` в keyboards
- Добавлена обработка кастомных команд в `bot/features/tasks.py`
- Обновлены типы callback кнопок в `CBT` класс

---

## [0.0.15] - 2026-01-07

### Добавлено

- **Инициализация автоответов при запуске**: При включении автоответов на подтверждение заказа или отзывы все существующие заказы загружаются как уже обработанные
- **Предотвращение спама старыми заказами**: Автоответы теперь отправляются только на новые заказы после включения функции
- **Детальное меню плагинов**: Добавлено отображение количества активных и отключенных плагинов
- **Напоминания про перезапуск**: После действий с плагинами показывается кликабельная команда `/restart`

### Улучшено

- **Автоответы**: Теперь при включении функции автоматически инициализируются все текущие заказы как обработанные
- **Меню плагинов**: Одинаковое детальное отображение при первом входе и при возврате из подменю
- **Логирование автоответов**: Показывается количество загруженных завершенных заказов и отзывов при инициализации
- **Сообщение после загрузки плагина**: Добавлена команда `/restart` для удобства

### Исправлено

- **Массовая отправка автоответов**: Исправлена проблема, когда при включении автоответов бот отправлял сообщения на все старые заказы
- **Дублирование автоответов**: Устранено повторное срабатывание автоответов каждые 5 минут на одни и те же заказы
- **Отображение меню плагинов**: Исправлена несогласованность отображения при первом входе и при возврате назад

---
